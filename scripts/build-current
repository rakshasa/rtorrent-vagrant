#!/usr/bin/env bash

set -e

source "`dirname ${BASH_SOURCE[0]}`/include/call"

if [ "$1" == "-r" ]; then
    SKIP_LIBTORRENT="yes"
fi

RTORRENT_CONF=("--with-xmlrpc-c")
LIBTORRENT_CONF=()

[ "${WITH_UDNS}" == yes ] && LIBTORRENT_CONF+=("--with-udns")
[ "${WITHOUT_UDNS}" == yes ] && LIBTORRENT_CONF+=("--without-udns")

[ "${SKIP_LIBTORRENT}" != yes ] && echo ${LIBTORRENT_CONF} > "${DATA_DIR}/current-libtorrent-conf"
[ "${SKIP_RTORRENT}" != yes ] && echo ${RTORRENT_CONF} > "${DATA_DIR}/current-rtorrent-conf"

call_build() {
  "${SCRIPT_DIR}/ssh" builder "\
USE_CXX=g++-4.8 \
BUILD_CONFIGURE=${BUILD_CONFIGURE} \
SKIP_LIBTORRENT=${SKIP_LIBTORRENT} \
LIBTORRENT_CONF=\"${LIBTORRENT_CONF}\" \
RTORRENT_CONF=\"${RTORRENT_CONF}\" \
build-rtorrent"
}

if [ "${BUILD_QUIET}" == yes ]; then
  echo "rtorrent started compiling..."
  call_quiet call_build
  call_quiet "${SCRIPT_DIR}/build-tags"
  echo "rtorrent finished compiling"
else
  call_build
  "${SCRIPT_DIR}/build-tags" > /dev/null
fi
