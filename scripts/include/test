#!/bin/bash

FAILED=0
LAST_VERIFY=

start_nodes() {
    echo "starting clients"
    "${SCRIPT_DIR}/start-rtorrent"

    echo "waiting for clients"

    if [ -n "${ACTIVE_NODES}" ]; then
        WAIT_NODES="${ACTIVE_NODES}" wait_for_nodes "is-client-active"
    else
        wait_for_nodes "is-client-active"
    fi
}

create_torrents() {
    "${SCRIPT_DIR}/test-create-all"

    local torrent=

    # TODO: Use variable.
    for torrent in test_h4 test_h6 test_u4 test_u6; do
        WAIT_NODES="${ACTIVE_NODES}" wait_for_nodes is-loaded ${torrent}
        echo "${torrent}: loaded"
    done
}

clean_all() {
    set -e

    echo "clean all"

    "${SCRIPT_DIR}/test-delete-all"
    WAIT_TIMEOUT=20 wait_for_nodes is-empty

    "${SCRIPT_DIR}/stop-rtorrent"; sleep 1
    "${SCRIPT_DIR}/config-clear"
}

setup_default() {
    "${SCRIPT_DIR}/build-tracker"

    ${SCRIPT_DIR}/ip-up-4 "node1 node2"
    ${SCRIPT_DIR}/ip-up-6 "node1 node3"
    ${SCRIPT_DIR}/ip-down-4 "node3"
    ${SCRIPT_DIR}/ip-down-6 "node2"
}

setup_default_v4() {
    IPV4_ONLY=yes "${SCRIPT_DIR}/build-tracker"

    ${SCRIPT_DIR}/ip-up-4 "node1 node2"
    ${SCRIPT_DIR}/ip-up-6 "node3"
    ${SCRIPT_DIR}/ip-down-4 "node3"
    ${SCRIPT_DIR}/ip-down-6 "node1 node2"
}

setup_default_v6() {
    "${SCRIPT_DIR}/build-tracker"

    ${SCRIPT_DIR}/ip-up-4 "node2"
    ${SCRIPT_DIR}/ip-up-6 "node1 node3"
    ${SCRIPT_DIR}/ip-down-4 "node1 node3"
    ${SCRIPT_DIR}/ip-down-6 "node2"
}

setup() {
    local config="${1:?Missing config setup argument.}"

    echo "setting up config '${config}'"

    case ${config} in
        "default")
            setup_default &> /dev/null
            ;;
        "default_v4")
            setup_default_v4 &> /dev/null
            ;;
        "default_v6")
            setup_default_v6 &> /dev/null
            ;;
    esac

    start_nodes
    create_torrents
    verify_seeds

    # TODO: Replace with check to see if we have in-progess.
    sleep 20
    set +e
}

exit_test() {
    echo

    if [[ ${FAILED} -eq 0 ]]; then
        echo "done: success"
    else
        echo "done: failed:${FAILED}"
    fi

    exit ${FAILED}
}

verify_seeds() {
    local torrent=

    # TODO: Use variable.
    for torrent in test_h4 test_h6 test_u4 test_u6; do
        WAIT_NODES=node1 WAIT_TIMEOUT=30 wait_for_nodes is-completed ${torrent}
        echo "${torrent}: seed ready"
    done
}

verify_completed() {
    local node="${1:?Missing node argument.}"
    local torrent="${2:?Missing torrent argument.}"
    local message="${3:?Missing message argument.}"

    [ -z "${LAST_VERIFY}" ] && echo
    LAST_VERIFY="${message}"

    if "${SCRIPT_DIR}/is-completed" "${node}" "${torrent}"; then
        echo -e "${GREEN}${message}... succeeded${NC}"
    else
        echo -e "${RED}${message}... failed${NC}"
        (( FAILED++ ))
    fi

    return 0
}

verify_incompleted() {
    local node="${1:?Missing node argument.}"
    local torrent="${2:?Missing torrent argument.}"
    local message="${3:?Missing message argument.}"

    [ -z "${LAST_VERIFY}" ] && echo
    LAST_VERIFY="${message}"

    if "${SCRIPT_DIR}/is-completed" "${node}" "${torrent}"; then
        echo -e "${RED}${message}... failed${NC}"
        (( FAILED++ ))
    else
        echo -e "${GREEN}${message}... succeeded${NC}"
    fi

    return 0
}

verify_has_log_message() {
    local node="${1:?Missing node argument.}"
    local log_name="${2:?Missing log name argument.}"
    local message="${3:?Missing message argument.}"
    local log_message="${4:?Missing message argument.}"

    [ -z "${LAST_VERIFY}" ] && echo
    LAST_VERIFY="${message}"

    if grep "${log_message}" "${DATA_DIR}/${node}/log/${log_name}.log" &> /dev/null; then
        echo -e "${GREEN}${message}... succeeded${NC}"
    else
        echo -e "${RED}${message}... failed${NC}"
        (( FAILED++ ))
    fi

    return 0
}

verify_bind_failed() {
    local node="${1:?Missing node argument.}"
    local message="${2:?Missing message argument.}"

    verify_has_log_message ${node} crash "${message}" "C Caught exception: 'Could not open/bind port for listening: Cannot assign requested address'."
}
